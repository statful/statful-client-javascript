/**
* statful-client-javascript 2.0.3
* Copyright 2017 Statful <https://www.statful.com/>
*/

!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.statful=r()}(this,function(){"use strict";!function(e){void 0===e&&(e={}),void 0===e.performance&&(e.performance={}),e._perfRefForUserTimingPolyfill=e.performance,e.performance.userTimingJsNow=!1,e.performance.userTimingJsNowPrefixed=!1,e.performance.userTimingJsUserTiming=!1,e.performance.userTimingJsUserTimingPrefixed=!1,e.performance.userTimingJsPerformanceTimeline=!1,e.performance.userTimingJsPerformanceTimelinePrefixed=!1;var r,t,n=[],i=[],o=null;if("function"!=typeof e.performance.now){for(e.performance.userTimingJsNow=!0,i=["webkitNow","msNow","mozNow"],r=0;r<i.length;r++)if("function"==typeof e.performance[i[r]]){e.performance.now=e.performance[i[r]],e.performance.userTimingJsNowPrefixed=!0;break}var a=+new Date;e.performance.timing&&e.performance.timing.navigationStart?a=e.performance.timing.navigationStart:"undefined"!=typeof process&&"function"==typeof process.hrtime&&(a=process.hrtime(),e.performance.now=function(){var e=process.hrtime(a);return 1e3*e[0]+1e-6*e[1]}),"function"!=typeof e.performance.now&&(Date.now?e.performance.now=function(){return Date.now()-a}:e.performance.now=function(){return+new Date-a})}var s=function(){},u=function(){},c=[],f=!1,g=!1;if("function"!=typeof e.performance.getEntries||"function"!=typeof e.performance.mark){for("function"==typeof e.performance.getEntries&&"function"!=typeof e.performance.mark&&(g=!0),e.performance.userTimingJsPerformanceTimeline=!0,n=["webkit","moz"],i=["getEntries","getEntriesByName","getEntriesByType"],r=0;r<i.length;r++)for(t=0;t<n.length;t++)o=n[t]+i[r].substr(0,1).toUpperCase()+i[r].substr(1),"function"==typeof e.performance[o]&&(e.performance[i[r]]=e.performance[o],e.performance.userTimingJsPerformanceTimelinePrefixed=!0);s=function(e){c.push(e),"measure"===e.entryType&&(f=!0)};var m=function(){f&&(c.sort(function(e,r){return e.startTime-r.startTime}),f=!1)};if(u=function(e,t){for(r=0;r<c.length;)c[r].entryType===e&&(void 0===t||c[r].name===t)?c.splice(r,1):r++},"function"!=typeof e.performance.getEntries||g){var l=e.performance.getEntries;e.performance.getEntries=function(){m();var r=c.slice(0);return g&&l&&(Array.prototype.push.apply(r,l.call(e.performance)),r.sort(function(e,r){return e.startTime-r.startTime})),r}}if("function"!=typeof e.performance.getEntriesByType||g){var p=e.performance.getEntriesByType;e.performance.getEntriesByType=function(t){if(void 0===t||"mark"!==t&&"measure"!==t)return g&&p?p.call(e.performance,t):[];"measure"===t&&m();var n=[];for(r=0;r<c.length;r++)c[r].entryType===t&&n.push(c[r]);return n}}if("function"!=typeof e.performance.getEntriesByName||g){var d=e.performance.getEntriesByName;e.performance.getEntriesByName=function(t,n){if(n&&"mark"!==n&&"measure"!==n)return g&&d?d.call(e.performance,t,n):[];void 0!==n&&"measure"===n&&m();var i=[];for(r=0;r<c.length;r++)void 0!==n&&c[r].entryType!==n||c[r].name===t&&i.push(c[r]);return g&&d&&(Array.prototype.push.apply(i,d.call(e.performance,t,n)),i.sort(function(e,r){return e.startTime-r.startTime})),i}}}if("function"!=typeof e.performance.mark){for(e.performance.userTimingJsUserTiming=!0,n=["webkit","moz","ms"],i=["mark","measure","clearMarks","clearMeasures"],r=0;r<i.length;r++)for(t=0;t<n.length;t++)o=n[t]+i[r].substr(0,1).toUpperCase()+i[r].substr(1),"function"==typeof e.performance[o]&&(e.performance[i[r]]=e.performance[o],e.performance.userTimingJsUserTimingPrefixed=!0);var h={};"function"!=typeof e.performance.mark&&(e.performance.mark=function(r){var t=e.performance.now();if(void 0===r)throw new SyntaxError("Mark name must be specified");if(e.performance.timing&&r in e.performance.timing)throw new SyntaxError("Mark name is not allowed");h[r]||(h[r]=[]),h[r].push(t),s({entryType:"mark",name:r,startTime:t,duration:0})}),"function"!=typeof e.performance.clearMarks&&(e.performance.clearMarks=function(e){e?h[e]=[]:h={},u("mark",e)}),"function"!=typeof e.performance.measure&&(e.performance.measure=function(r,t,n){var i=e.performance.now();if(void 0===r)throw new SyntaxError("Measure must be specified");if(t){var o=0;if(e.performance.timing&&t in e.performance.timing){if("navigationStart"!==t&&0===e.performance.timing[t])throw new Error(t+" has a timing of 0");o=e.performance.timing[t]-e.performance.timing.navigationStart}else{if(!(t in h))throw new Error(t+" mark not found");o=h[t][h[t].length-1]}var a=i;if(n)if(a=0,e.performance.timing&&n in e.performance.timing){if("navigationStart"!==n&&0===e.performance.timing[n])throw new Error(n+" has a timing of 0");a=e.performance.timing[n]-e.performance.timing.navigationStart}else{if(!(n in h))throw new Error(n+" mark not found");a=h[n][h[n].length-1]}s({entryType:"measure",name:r,startTime:o,duration:a-o})}else s({entryType:"measure",name:r,startTime:0,duration:i})}),"function"!=typeof e.performance.clearMeasures&&(e.performance.clearMeasures=function(e){u("measure",e)})}"function"==typeof define&&define.amd?define([],function(){return e.performance}):"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=e.performance)}("undefined"!=typeof window?window:void 0);var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),n=function(){function e(t){r(this,e),this.debugEnabled=t||!1}return t(e,[{key:"info",value:function(){this.debugEnabled&&console.info.apply(console,Array.prototype.slice.call(arguments))}},{key:"debug",value:function(){this.debugEnabled&&console.debug.apply(console,Array.prototype.slice.call(arguments))}},{key:"error",value:function(){this.debugEnabled&&console.error.apply(console,Array.prototype.slice.call(arguments))}}]),e}(),i=function(){function e(t){var i=this;r(this,e),this.config={},this.listQueues=[],Object.keys(t).forEach(function(e){i.config[e]=t[e]}),this.logger=new n(this.config.debug)}return t(e,[{key:"sendRequest",value:function(e,r){var t=this,n=[this.config.apiAddress,e].join("/");this.logger.debug("Request: "+n,r);var i=new XMLHttpRequest;i.open("POST",n,!0),i.timeout=this.config.timeout,i.setRequestHeader("Content-type","application/json"),i.send(r),i.onreadystatechange=function(){200==i.status||201==i.status?t.logger.debug("Successfully send metric"):t.logger.debug("Error send metric",n,i.status)}}},{key:"registerQueue",value:function(e,r,t){var n=this;return t=t||this.config.flushInterval,"string"==typeof e&&"number"==typeof t&&(this.listQueues[e]={data:[],endpoint:r},this.listQueues[e].timer=setInterval(function(){var r=n.listQueues[e];r.data.length>0&&(n.config.dryrun?n.logger.debug("Dryrun data",r.endpoint,r.data):n.sendRequest(r.endpoint,JSON.stringify(r.data)),r.data=[])},t),!0)}},{key:"unregisterQueue",value:function(e){this.listQueues[e]&&(clearInterval(this.listQueues[e].timer),this.listQueues[e]=void 0)}},{key:"addItemToQueue",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=(r.sampleRate||this.config.sampleRate||100)/100;return this.listQueues[e]&&Math.random()<=t?(this.listQueues[e].data.push(r),!0):(this.logger.debug("Metric was discarded due to sample rate."),!1)}}]),e}(),o=["avg","count","sum","first","last","p90","p95","min","max"],a=[10,30,60,120,180,300],s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};r(this,e),this.name=t,this.type=n,this.value=i;var s=[],u=[],c=0;a[n]&&(s=a[n].tags,u=a[n].aggregations,c=a[n].aggregationFrequency),this.tags=this.setTags(o.tags,a.tags,s,a.app),this.aggregations=this.setAggregations(o.aggregations,a.aggregations,u),this.aggregationFrequency=this.setAggregationFrequency(o.aggregationFrequency,a.aggregationFrequency,c),this.namespace=o.namespace||a.namespace,this.sampleRate=o.sampleRate||a.sampleRate}return t(e,[{key:"setTags",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],i={};return Object.assign(i,r),Object.assign(i,t),Object.assign(i,e),!i.app&&n&&(i.app=n),i}},{key:"setAggregations",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=r;return n=n.concat(t).filter(this.uniq),n=n.concat(e).filter(this.uniq),this.filterAggregations(n)}},{key:"uniq",value:function(e,r,t){return e&&t.indexOf(e)===r}},{key:"setAggregationFrequency",value:function(e,r,t){var n=e||t||r;return this.filterAggregationFrequency(n)}},{key:"filterAggregations",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).filter(function(e){return o.includes(e)})}},{key:"filterAggregationFrequency",value:function(e){var r=10;return a.includes(e)&&(r=e),r}}]),e}(),u={dryrun:!1,debug:!1,app:void 0,namespace:"web",tags:{},aggregations:[],aggregationFrequency:10,timer:{tags:{unit:"ms"},aggregations:["avg","p90","count"]},counter:{tags:{},aggregations:["sum","count"]},gauge:{tags:{},aggregations:["last"]},timeout:2e3,flushInterval:1e4,sampleRate:100};return function(){function o(){r(this,o)}return t(o,null,[{key:"initialize",value:function(r){this.config={apiAddress:"https://beacon.statful.com"},this.endpoints={metrics:"beacon/metrics"},"object"===(void 0===r?"undefined":e(r))&&null!==r||(r={}),Object.assign(this.config,u),Object.assign(this.config,r),this.logger=new n(this.config.debug),this.util=new i({apiAddress:this.config.apiAddress,debug:this.config.debug,dryrun:this.config.dryrun,flushInterval:this.config.flushInterval,timeout:this.config.timeout}),this.util.registerQueue("metrics",this.endpoints.metrics,this.config.flushInterval)}},{key:"measureTimeUserTiming",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=void 0,t=window.performance.getEntriesByName(e).filter(function(e){return"measure"===e.entryType});return t.length>0?r=t[t.length-1].duration:this.logger.debug("Measure "+e+" not found"),r}},{key:"clearMarks",value:function(e){try{e?e.forEach(function(e){e&&window.performance.clearMarks(e)}):window.performance.clearMarks()}catch(e){this.logger.error(e)}}},{key:"clearResources",value:function(){try{window.performance.clearResourceTimings()}catch(e){this.logger.error(e)}}},{key:"clearMeasures",value:function(e){try{e?e.forEach(function(e){window.performance.clearMeasures(e)}):window.performance.clearMeasures()}catch(e){this.logger.error(e)}}},{key:"registerMark",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{this.logger.debug("Register Mark",e),e?window.performance.mark(e):this.logger.error("Undefined resource name to register as a mark")}catch(e){this.logger.error(e)}}},{key:"registerMeasure",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{if(this.logger.debug("Register Measure",e,r,t),e){var n={clearMarks:!1,clearMeasures:!1};t=t||{},Object.keys(t).forEach(function(e){n[e]=t[e]}),n.endMark||(this.registerMark(e),n.endMark=e),window.performance.measure(e,n.startMark,n.endMark);var i=this.measureTimeUserTiming(e);if(i){var o=new s(r,"timer",i,n,this.config);this.util.addItemToQueue("metrics",o)}else this.logger.error("Failed to get measure time to register as timer value");n.clearMarks&&this.clearMarks([n.startMark,n.endMark]),n.clearMeasures&&this.clearMeasures([e])}else this.logger.error("Undefined resource name to register as a measure")}catch(e){this.logger.error(e)}}},{key:"timer",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{if(this.logger.debug("Register Timer",e,r,t),e&&r>=0){var n=new s(e,"timer",r,t=t||{},this.config);this.util.addItemToQueue("metrics",n)}else this.logger.error("Undefined metric name or invalid value to register as a timer")}catch(e){this.logger.error(e)}}},{key:"counter",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{if(this.logger.debug("Register Counter",e,t),r=r||1,e){var n=new s(e,"counter",r,t=t||{},this.config);this.util.addItemToQueue("metrics",n)}else this.logger.error("Undefined metric name to register as a counter")}catch(e){this.logger.error(e)}}},{key:"gauge",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{if(this.logger.debug("Register Gauge",e,r,t),e&&r){var n=new s(e,"gauge",r,t,this.config);this.util.addItemToQueue("metrics",n)}else this.logger.error("Undefined metric name/value to register as a gauge")}catch(e){this.logger.error(e)}}}]),o}()});
