/**
* statful-client-javascript 2.0.2
* Copyright 2017 Statful <https://www.statful.com/>
*/

var statful=function(){"use strict";function e(e){e=e||{};var r,t=this;this.config={},this.constants={aggregationList:["avg","count","sum","first","last","p90","p95","min","max"],aggregationFrequencyList:[10,30,60,120,180,300]},Object.keys(e).forEach(function(r){t.config[r]=e[r]}),this.listQueues=[],r=new a(t.config.debug),this.sendRequest=function(t,n){var i=[this.config.apiAddress,t].join("/");r.debug("Request: "+i,n);var a=new XMLHttpRequest;a.open("POST",i,!0),a.timeout=e.timeout,a.setRequestHeader("Content-type","application/json"),a.send(n),a.onreadystatechange=function(){200==a.status||201==a.status?r.debug("Successfully send metric"):r.debug("Error send metric",i,a.status)}},this.registerQueue=function(e,t,n){if(n=n||this.config.flushInterval,"string"==typeof e&&"number"==typeof n){var i=this;return this.listQueues[e]={data:[],endpoint:t},this.listQueues[e].timer=setInterval(function(){var t=i.listQueues[e];t.data.length>0&&(i.config.dryrun?r.debug("Dryrun data",t.endpoint,t.data):i.sendRequest(t.endpoint,JSON.stringify(t.data)),t.data=[])},n),!0}return!1},this.unregisterQueue=function(e){this.listQueues[e]&&(clearInterval(this.listQueues[e].timer),this.listQueues[e]=void 0)},this.addItemToQueue=function(e,t){var n=(t.sampleRate||this.config.sampleRate||100)/100;return this.listQueues[e]&&Math.random()<=n?(this.listQueues[e].data.push(t),!0):(r.debug("Metric was discarded due to sample rate."),!1)},this.setAggregations=function(e,r,t){function n(e,r,t){return e&&t.indexOf(e)===r}var i=r;return i=i.concat(t).filter(n),i=e?i.concat(e).filter(n):i||[],this.filterAggregations(i)},this.setTags=function(e,r,t,n){var i={};return Object.keys(r).forEach(function(e){i[e]=r[e]}),Object.keys(t).forEach(function(e){i[e]=t[e]}),Object.keys(e).forEach(function(r){i[r]=e[r]}),!i.app&&n&&(i.app=n),i},this.setAggregationFrequency=function(e,r,t){var n=r;return t&&(n=t),e&&(n=e),this.filterAggregationFrequency(n)},this.filterAggregations=function(e){var r=this.constants.aggregationList;return(e=e||[]).filter(function(e){return-1!==r.indexOf(e)})},this.filterAggregationFrequency=function(e){var r=10;return this.constants.aggregationFrequencyList.indexOf(e)>-1&&(r=e),r}}!function(e){void 0===e&&(e={}),void 0===e.performance&&(e.performance={}),e._perfRefForUserTimingPolyfill=e.performance,e.performance.userTimingJsNow=!1,e.performance.userTimingJsNowPrefixed=!1,e.performance.userTimingJsUserTiming=!1,e.performance.userTimingJsUserTimingPrefixed=!1,e.performance.userTimingJsPerformanceTimeline=!1,e.performance.userTimingJsPerformanceTimelinePrefixed=!1;var r,t,n=[],i=[],a=null;if("function"!=typeof e.performance.now){for(e.performance.userTimingJsNow=!0,i=["webkitNow","msNow","mozNow"],r=0;r<i.length;r++)if("function"==typeof e.performance[i[r]]){e.performance.now=e.performance[i[r]],e.performance.userTimingJsNowPrefixed=!0;break}var o=+new Date;e.performance.timing&&e.performance.timing.navigationStart?o=e.performance.timing.navigationStart:"undefined"!=typeof process&&"function"==typeof process.hrtime&&(o=process.hrtime(),e.performance.now=function(){var e=process.hrtime(o);return 1e3*e[0]+1e-6*e[1]}),"function"!=typeof e.performance.now&&(Date.now?e.performance.now=function(){return Date.now()-o}:e.performance.now=function(){return+new Date-o})}var s=function(){},c=function(){},f=[],u=!1,m=!1;if("function"!=typeof e.performance.getEntries||"function"!=typeof e.performance.mark){for("function"==typeof e.performance.getEntries&&"function"!=typeof e.performance.mark&&(m=!0),e.performance.userTimingJsPerformanceTimeline=!0,n=["webkit","moz"],i=["getEntries","getEntriesByName","getEntriesByType"],r=0;r<i.length;r++)for(t=0;t<n.length;t++)a=n[t]+i[r].substr(0,1).toUpperCase()+i[r].substr(1),"function"==typeof e.performance[a]&&(e.performance[i[r]]=e.performance[a],e.performance.userTimingJsPerformanceTimelinePrefixed=!0);s=function(e){f.push(e),"measure"===e.entryType&&(u=!0)};var g=function(){u&&(f.sort(function(e,r){return e.startTime-r.startTime}),u=!1)};if(c=function(e,t){for(r=0;r<f.length;)f[r].entryType===e&&(void 0===t||f[r].name===t)?f.splice(r,1):r++},"function"!=typeof e.performance.getEntries||m){var p=e.performance.getEntries;e.performance.getEntries=function(){g();var r=f.slice(0);return m&&p&&(Array.prototype.push.apply(r,p.call(e.performance)),r.sort(function(e,r){return e.startTime-r.startTime})),r}}if("function"!=typeof e.performance.getEntriesByType||m){var l=e.performance.getEntriesByType;e.performance.getEntriesByType=function(t){if(void 0===t||"mark"!==t&&"measure"!==t)return m&&l?l.call(e.performance,t):[];"measure"===t&&g();var n=[];for(r=0;r<f.length;r++)f[r].entryType===t&&n.push(f[r]);return n}}if("function"!=typeof e.performance.getEntriesByName||m){var d=e.performance.getEntriesByName;e.performance.getEntriesByName=function(t,n){if(n&&"mark"!==n&&"measure"!==n)return m&&d?d.call(e.performance,t,n):[];void 0!==n&&"measure"===n&&g();var i=[];for(r=0;r<f.length;r++)void 0!==n&&f[r].entryType!==n||f[r].name===t&&i.push(f[r]);return m&&d&&(Array.prototype.push.apply(i,d.call(e.performance,t,n)),i.sort(function(e,r){return e.startTime-r.startTime})),i}}}if("function"!=typeof e.performance.mark){for(e.performance.userTimingJsUserTiming=!0,n=["webkit","moz","ms"],i=["mark","measure","clearMarks","clearMeasures"],r=0;r<i.length;r++)for(t=0;t<n.length;t++)a=n[t]+i[r].substr(0,1).toUpperCase()+i[r].substr(1),"function"==typeof e.performance[a]&&(e.performance[i[r]]=e.performance[a],e.performance.userTimingJsUserTimingPrefixed=!0);var y={};"function"!=typeof e.performance.mark&&(e.performance.mark=function(r){var t=e.performance.now();if(void 0===r)throw new SyntaxError("Mark name must be specified");if(e.performance.timing&&r in e.performance.timing)throw new SyntaxError("Mark name is not allowed");y[r]||(y[r]=[]),y[r].push(t),s({entryType:"mark",name:r,startTime:t,duration:0})}),"function"!=typeof e.performance.clearMarks&&(e.performance.clearMarks=function(e){e?y[e]=[]:y={},c("mark",e)}),"function"!=typeof e.performance.measure&&(e.performance.measure=function(r,t,n){var i=e.performance.now();if(void 0===r)throw new SyntaxError("Measure must be specified");if(t){var a=0;if(e.performance.timing&&t in e.performance.timing){if("navigationStart"!==t&&0===e.performance.timing[t])throw new Error(t+" has a timing of 0");a=e.performance.timing[t]-e.performance.timing.navigationStart}else{if(!(t in y))throw new Error(t+" mark not found");a=y[t][y[t].length-1]}var o=i;if(n)if(o=0,e.performance.timing&&n in e.performance.timing){if("navigationStart"!==n&&0===e.performance.timing[n])throw new Error(n+" has a timing of 0");o=e.performance.timing[n]-e.performance.timing.navigationStart}else{if(!(n in y))throw new Error(n+" mark not found");o=y[n][y[n].length-1]}s({entryType:"measure",name:r,startTime:a,duration:o-a})}else s({entryType:"measure",name:r,startTime:0,duration:i})}),"function"!=typeof e.performance.clearMeasures&&(e.performance.clearMeasures=function(e){c("measure",e)})}"function"==typeof define&&define.amd?define([],function(){return e.performance}):"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=e.performance)}("undefined"!=typeof window?window:void 0);var r,t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),a=function(){function e(r){n(this,e),this.debugEnabled=r||!1}return i(e,[{key:"info",value:function(){this.debugEnabled&&console.info.apply(console,Array.prototype.slice.call(arguments))}},{key:"debug",value:function(){this.debugEnabled&&console.debug.apply(console,Array.prototype.slice.call(arguments))}},{key:"error",value:function(){this.debugEnabled&&console.error.apply(console,Array.prototype.slice.call(arguments))}}]),e}(),o={dryrun:!1,debug:!1,app:void 0,namespace:"web",tags:{},aggregations:[],aggregationFrequency:10,timer:{tags:{unit:"ms"},aggregations:["avg","p90","count"]},counter:{tags:{},aggregations:["sum","count"]},gauge:{tags:{},aggregations:["last"]},timeout:2e3,flushInterval:1e4,sampleRate:100},s={config:{apiAddress:"https://beacon.statful.com"},endpoints:{metrics:"beacon/metrics"},perf:window.performance,initialize:function(n){var i=this;i.mergeConfigs=function(e){"object"===(void 0===e?"undefined":t(e))&&null!==e||(e={}),Object.keys(o).forEach(function(e){i.config[e]=o[e]}),Object.keys(e).forEach(function(r){i.config[r]=e[r]})},i.metricsData=function(e,r,t,n,a,o,s,c){return{name:e,type:r,value:t,tags:i.util.setTags(n||{},i.config.tags,i.config[r].tags,i.config.app),aggregations:i.util.setAggregations(a,i.config.aggregations,i.config[r].aggregations),aggregationFrequency:i.util.setAggregationFrequency(o,i.config.aggregationFrequency,i.config[r].aggregationFrequency),namespace:s||i.config.namespace,sampleRate:c||i.config.sampleRate}},this.mergeConfigs(n),r=new a(i.config.debug),i.util=new e({apiAddress:this.config.apiAddress,debug:this.config.debug,dryrun:this.config.dryrun,flushInterval:this.config.flushInterval,timeout:this.config.timeout}),i.util.registerQueue("metrics",this.endpoints.metrics,this.config.flushInterval)},measureTimeUserTiming:function(e){var t,n=s.perf.getEntriesByName(e).filter(function(e){return"measure"===e.entryType});return n.length>0?t=n[n.length-1].duration:r.debug("Measure "+e+" not found"),t},clearMarks:function(e){try{e?e.forEach(function(e){e&&s.perf.clearMarks(e)}):s.perf.clearMarks()}catch(e){r.error(e)}},clearResources:function(){try{s.perf.clearResourceTimings()}catch(e){r.error(e)}},clearMeasures:function(e){try{e?e.forEach(function(e){s.perf.clearMeasures(e)}):s.perf.clearMeasures()}catch(e){r.error(e)}},registerMark:function(e){try{r.debug("Register Mark",e),e?s.perf.mark(e):r.error("Undefined resource name to register as a mark")}catch(e){r.error(e)}},registerMeasure:function(e,t,n){try{if(r.debug("Register Measure",e,t,n),e){var i={clearMarks:!1,clearMeasures:!1};n=n||{},Object.keys(n).forEach(function(e){i[e]=n[e]}),i.endMark||(this.registerMark(e),i.endMark=e),s.perf.measure(e,i.startMark,i.endMark);var a=this.measureTimeUserTiming(e);a?this.util.addItemToQueue("metrics",new this.metricsData(t,"timer",a,i.tags,i.aggregations,i.aggregationFrequency,i.namespace,i.sampleRate)):r.error("Failed to get measure time to register as timer value"),i.clearMarks&&this.clearMarks([i.startMark,i.endMark]),i.clearMeasures&&this.clearMeasures([e])}else r.error("Undefined resource name to register as a measure")}catch(e){r.error(e)}},timer:function(e,t,n){try{if(r.debug("Register Timer",e,t,n),e&&t>=0){n=n||{};var i=new this.metricsData(e,"timer",t,n.tags,n.agg,n.aggFreq,n.namespace,n.sampleRate);this.util.addItemToQueue("metrics",i)}else r.error("Undefined metric name or invalid value to register as a timer")}catch(e){r.error(e)}},counter:function(e,t,n){try{if(r.debug("Register Counter",e,n),t=t||1,e){n=n||{};var i=new this.metricsData(e,"counter",t,n.tags,n.agg,n.aggFreq,n.namespace,n.sampleRate);this.util.addItemToQueue("metrics",i)}else r.error("Undefined metric name to register as a counter")}catch(e){r.error(e)}},gauge:function(e,t,n){try{if(r.debug("Register Gauge",e,t,n),e&&t){n=n||{};var i=new this.metricsData(e,"gauge",t,n.tags,n.agg,n.aggFreq,n.namespace,n.sampleRate);this.util.addItemToQueue("metrics",i)}else r.error("Undefined metric name/value to register as a gauge")}catch(e){r.error(e)}}};return s}();
